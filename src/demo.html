<html>
<head>
  <script type="module">
  /**
   * Demo showing smart card based authentication using WebUSB and CCID
   * TODO: implement authentication
   *
   * Copyright (C) 2017, Jan Birkholz <jbirkhol@informatik.hu-berlin.de>
   */
  import * as ccid from "./ccid.js";
  import * as ifd from "./ifd.js";
  import * as iso78164 from "./7816-4.js";
  import * as util from "./util.js";

  /**
   * Control displayed status HTML element
   */
  let status = { //TODO: idea to put status object into ifd.js and subscribe to it here
    clear: () => {
      document.querySelector("#status").textContent = "";
    },
    show: (message) => {
      document.querySelector("#status").textContent = message;
    }
  };

  document.addEventListener("readerStatus", function (e) { //CustomEvent readerStatus, triggered by ifd.js on document
    status.show(e.detail);
  });
  document.addEventListener("logEvent", function(e) {
    util.log(e.detail);
    status.clear();
  });

  window.addEventListener("load",()=>{
    status.clear();
    ifd.init().catch(error=>{status.show(error);util.log(error,true);throw error;});


    document.getElementById("requestDevice").addEventListener("click",(clickEvent)=>{
      status.clear();
      return ifd.requestDevice(clickEvent).catch(error=>{status.show(error);util.log(error,true);throw error;});
    });
    document.getElementById("getDevices").addEventListener("click",()=>{
      status.clear();

      //TODO reimplement
    }); //end of getDevices

    document.getElementById("getChallenge").addEventListener("click",()=>{
      status.clear();
      let getChallengeAPDU = iso78164.apdus.GET_CHALLENGE(1);
      return ifd.initCard().then(()=>{
        return ifd.sendAPDU(getChallengeAPDU).then(responseAPDU=>{
          util.log(responseAPDU);
        });
      });
    });



    let socket = null;
    document.getElementById("proxy").addEventListener("click",()=>{
      //server eg https://github.com/dpallot/simple-websocket-server
      //first demo receives apdu on WebSocket and acts as a simple proxy, no protocol
      //(1) open websocket connection to host
      let sendMessage = () => {
        //socket.send("some text"); //send dataTypes: USVString(UTF-8), ArrayBuffer(View), Blob
        socket.send(new Uint8Array([0x01,0x02]));
      };
      if(socket === null) {
        socket = new WebSocket('ws://localhost:8081');
        socket.addEventListener("open", openEvent=>{
          sendMessage();
        });
        socket.addEventListener("message",msgEvent=>{
          console.log(msgEvent);
          //let msg = JSON.parse(msgEvent.data); //msg: {apdu:}
        });
        socket.addEventListener("close",closeEvent=>{
          console.log(closeEvent);
        });
      } else {
        sendMessage();
      }






      //(2) send and receive apdus
      /*
        How should the protocol look like?
        - endianness is not a problem at this layer, we do not encode here
        - security is  an issue because we create a new connection outside our HTTP TLS session. Does the server check if its this valid session: No.
          + if session and socket are the same we do not need any versioning, because we know its a current version

       */
    });

  }); //end of load
  </script>
</head>
<body>
  <p><button id="requestDevice">connect</button></p>
  <p id="debug">
    <button id="getDevices" style="display:none">getDevices</button>
    <button id="getChallenge">Get challenge</button>
    <button id="proxy" style="display:block">proxy apdus</button>
  </p>
  <p>Status: <span id="status"></span></p> <!-- rename to error -->
  <p><textarea id="log" readonly rows="24" cols="80"></textarea></p>
</body>
</html>
