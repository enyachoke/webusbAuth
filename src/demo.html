<html>
<head>
  <script type="module">
  /**
   * Demo showing smart card based authentication using WebUSB and CCID
   * TODO: implement authentication
   *
   * Copyright (C) 2017, Jan Birkholz <jbirkhol@informatik.hu-berlin.de>
   */
  import * as ccid from "./ccid.js";
  import * as ifd from "./ifd.js";
  import * as iso78164 from "./7816-4.js";
  import * as util from "./util.js";

  /**
   * Control displayed status HTML element
   */
  let status = { //TODO: idea to put status object into ifd.js and subscribe to it here
    clear: () => {
      document.querySelector("#status").textContent = "";
    },
    show: (message) => {
      document.querySelector("#status").textContent = message;
    }
  };

  document.addEventListener("readerStatus", function (e) { //CustomEvent readerStatus, triggered by ifd.js on document
    status.show(e.detail);
  });
  document.addEventListener("logEvent", function(e) {
    util.log(e.detail);
    status.clear();
  });

  window.addEventListener("load",()=>{
    status.clear();
    ifd.init().catch(error=>{status.show(error);util.log(error,true);throw error;});


    document.getElementById("requestDevice").addEventListener("click",(clickEvent)=>{
      status.clear();
      return ifd.requestDevice(clickEvent).catch(error=>{status.show(error);util.log(error,true);throw error;});
    });
    document.getElementById("getDevices").addEventListener("click",()=>{
      status.clear();

      //TODO reimplement
    }); //end of getDevices

    document.getElementById("getChallenge").addEventListener("click",()=>{
      status.clear();
      let getChallengeAPDU = iso78164.apdus.GET_CHALLENGE(1);
      return ifd.initCard().then(()=>{
        return ifd.sendAPDU(getChallengeAPDU).then(responseAPDU=>{
          util.log(responseAPDU);
        });
      });
    });



    let socket = null;
    document.getElementById("proxy").addEventListener("click",()=>{
      //demo receives apdu on WebSocket open and forwards single message
      //(1) open websocket connection to host
      if(socket === null) {
        return ifd.initCard().then(initialized=>{ //init card
          if(!initialized) throw new Error("Smart card init failed.");

          //open WebSocket
          socket = new WebSocket('ws://localhost:8081');
          socket.addEventListener("open", openEvent=>{

          });

          socket.addEventListener("message",msgEvent=>{ //in demo, server controls interaction
            let receivedAPDU = msgEvent.data;

            //extract APDU from Blob
            if(receivedAPDU instanceof Blob) {
              let blobReader = new FileReader();
              blobReader.addEventListener("loadend",event=>{
                let apduArrayBuffer = blobReader.result;
                let receivedAPDUUint8Array = new Uint8Array(apduArrayBuffer);

                //send APDU to ccid
                ifd.sendAPDU(receivedAPDUUint8Array).then(responseAPDU=>{
                  util.log(responseAPDU);
                  //forward response
                  socket.send(responseAPDU);
                });
              });
              blobReader.readAsArrayBuffer(receivedAPDU);
            } else {
              throw new Error("Blob encoded APDU expected from WebSocket server.")
            }
          });

          socket.addEventListener("close",closeEvent=>{
            util.log("WebSocket closed.");
          });
        });
      }
      /*else {
        sendMessage();
      }*/

      //(2) send and receive apdus
      /*
        How should the protocol look like?
        - endianness is not a problem at this layer, we do not encode here
        - security is  an issue because we create a new connection outside our HTTP TLS session. Does the server check if its this valid session: No.
          + if session and socket are the same we do not need any versioning, because we know its a current version

       */
    });

    let diceElement = document.querySelector("svg#diceSvg");
    diceElement.addEventListener("click", clickEvent => {
      status.clear();
      let getChallengeAPDU = iso78164.apdus.GET_CHALLENGE(6); //6 bytes to have a multiple of 6 for the dice (252*6 and 4*6)
      return ifd.initCard().then(()=>{
        return ifd.sendAPDU(getChallengeAPDU).then(responseAPDU=>{
          util.log(responseAPDU);
          let statusWord = responseAPDU.slice(responseAPDU.length-2,responseAPDU.length);
          if(statusWord[0]!== 0x90 && statusWord[1]!==0x00) throw new Error("Smart card signals error: "+statusWord[0]+" "+statusWord[1]);
          let randomNumberBytes = responseAPDU.slice(0,responseAPDU.length-2); //1 Byte 0-255
          util.log(randomNumberBytes);
          let dicenumber = 7;
          for(let i=0;i<randomNumberBytes.length;i++) {
            let byte = randomNumberBytes[i];
            if(byte<252) { //multiple of 6
              dicenumber=byte%6+1;
            }
            if(i==randomNumberBytes.length-1) { //we have 6 times a number >=252
              //rebuild last number by combining last 2 bits of each of the 6 numbers
              let combinedNumber = 0x00; //will be 0<=x<=23
              for(j=0;j<randomNumberBytes.length;j++) {
                let lastTwoBits = randomNumberBytes[j]&0x03; //-> 0, 1, 2 or 3
                if(j>0) lastTwoBits++; //for summing up
                combinedNumber+=lastTwoBits;
              }
              dicenumber = combinedNumber%6 +1;
            }
          }

          //let firstRandomNumberByte = randomNumberBytes[0];
          //let diceNumber = firstRandomNumberByte%6+1;
          //diceElement.innerHTML = "<div style='text-align:center;vertical-align:middle;line-height:100px;'>"+diceNumber+"</div>";
          let svgDice = document.querySelector("svg#diceSvg");
          for(var item of document.querySelector("svg#diceSvg").children) {item.style.display ="none";}
          if(isNaN(diceNumber)) diceNumber = 7; //error case
          document.querySelector("svg#diceSvg :nth-child("+diceNumber+")").style.display = "block";
        });
      });
    });

  }); //end of load
  </script>
</head>
<body>
  <p><button id="requestDevice">connect</button></p>

    <div id="row1" style="float:left;margin-top:10px;">
      <button id="getDevices" style="display:none">getDevices</button>
      <button id="getChallenge">Get challenge</button>
      <button id="proxy" style="display:block">proxy apdus</button>
    </div>
    <div id="row2" style="float:left;margin:10px;">
      <p>dice example</p>
      <svg id="diceSvg" style="border: 1px solid black;width:100px;height:100px;">
        <g style="display:none;"><circle cx="50" cy="50" r="10" fill="black" /></circle></g> <!-- stroke="green" stroke-width="4" -->
        <g style="display:none;" fill="black" >
          <circle cx="25" cy="25" r="10"/></circle>
          <circle cx="75" cy="75" r="10"/></circle>
        </g>
        <g style="display:none;" fill="black" >
          <circle cx="25" cy="25" r="10"/></circle>
          <circle cx="50" cy="50" r="10"/></circle>
          <circle cx="75" cy="75" r="10"/></circle>
        </g>
        <g style="display:none;" fill="black" >
          <circle cx="25" cy="25" r="10"/></circle>
          <circle cx="75" cy="25" r="10"/></circle>
          <circle cx="75" cy="75" r="10"/></circle>
          <circle cx="25" cy="75" r="10"/></circle>
        </g>
        <g style="display:none;" fill="black" >
          <circle cx="20" cy="20" r="10"/></circle>
          <circle cx="80" cy="20" r="10"/></circle>
          <circle cx="50" cy="50" r="10"/></circle>
          <circle cx="80" cy="80" r="10"/></circle>
          <circle cx="20" cy="80" r="10"/></circle>
        </g>
        <g style="display:none;" fill="black" >
          <circle cx="25" cy="25" r="10"/></circle>
          <circle cx="75" cy="25" r="10"/></circle>
          <circle cx="50" cy="25" r="10"/></circle>
          <circle cx="50" cy="75" r="10"/></circle>
          <circle cx="75" cy="75" r="10"/></circle>
          <circle cx="25" cy="75" r="10"/></circle>
        </g>
        <g style="display:none;" fill="black" >
          <text x="30" y="50">Error</text>
        </g>
      </svg>
      <p>Click square to roll dice.</p>
    </div>

  <div style="clear:both"></div>
  <p>Status: <span id="status"></span></p> <!-- rename to error -->
  <p><textarea id="log" readonly rows="24" cols="80"></textarea></p>
</body>
</html>
